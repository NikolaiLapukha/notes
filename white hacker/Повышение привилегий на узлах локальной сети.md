## **Основные понятия**

**Горизонтальное перемещение (lateral movement)** — один из этапов атаки на организацию, во время которого злоумышленник, уже сумевший проникнуть внутрь корпоративной инфраструктуры и закрепиться в ней, начинает продвигаться по сети от точки входа (например, скомпрометированного устройства или аккаунта) к другим объектам.

**Домен** – это основная административная единица в сетевой инфраструктуре предприятия, в которую входят все сетевые объекты, такие как пользователи, компьютеры, принтеры, общие ресурсы и т.д. Совокупность (иерархия) доменов называется **лесом.** У каждой компании может быть внешний и внутренний домен.

**Контроллер домена (domain controller)** — сервер, управляющий доступом к сетевым ресурсам в рамках одного домена (группы сетей или хостов, объединенных общими политиками безопасности). Контроллер домена осуществляет аутентификацию пользователя в домене, то есть позволяет ему входить в сеть с помощью одной и той же пары логин-пароль с любого включенного в домен компьютера, на котором это не запрещено политиками безопасности или локальными настройками.

## Наше положение в сети

Мы переходим к последнему крупному этапу: **атаки на локальную сеть компании.**​

​​​​​​Основная задача на этом этапе — **получить как можно больше данных, которые будут переиспользованы по всей сети Active Directory.**

![[Pasted image 20240613153849.png]]
## **Общие принципы**

В рамках основных принципов повышения привилегий мы рассмотрим 2 этапа:

1. Повышение привилегий на отдельной машине Windows 
2. Горизонтальное перемещение в сети с Windows машинами

**Основные категории методов повышения привилегий**

- _Использование физического доступа:_ например, когда вы получаете прямой доступ на уровне диска и изменяете пароль в файловой системе
- _Извлечение секретов и учетных данных:_ с получением различных прав доступа в Windows становится возможным извлекать секреты и учетные данные из различных хранилищ
- _Эксплуатация уязвимостей конфигурации ОС Windows:_ невероятно большое количество служб и сервисов в Windows должны быть корректно настроенными или отключенными, чтобы не дать доступа злоумышленнику воспользоваться недостаткам настройки
- _Эксплуатация известных уязвимостей ОС Windows:_ ежегодно в Windows обнаруживают и устраняют десятки и сотни уязвимостей, благодаря которым эксплуатация становится возможной, если система не обновлена до последней версии

## **Извлечение секретов и учетных данных**

Яркими представителями этой категории являются _следующие методы повышения привилегий:_

- Взлом менеджеров паролей пользователей по причине небезопасной конфигурации
- Обнаружение секретов и учетных данных в логах и истории команд
- Извлечение учетных данных из оперативной памяти
- Доступ к файлу, хранящему хеши пользовательских паролей 
- Извлечение учетных данных из конфигурации Групповых Политик

**Поиск секретов и паролей в ОС**

В первую очередь мы помним, что можно попытаться самостоятельно поискать пароли в различных файлах ОС при помощи команд терминальной оболочки, например:

`cd C:\ & findstr /s /p /i /n /m "password" *.xml *.ini *.txt *.config`

_Эта команда выполняет поиск строки "password" внутри всех файлов с расширениями .xml, .ini, .txt и .config в текущем диске C:._

## **Извлечение учетных данных из оперативной памяти**

_Самым ярким примером_ здесь будет извлечение учетных данных из оперативной памяти процессов.

> **_Факт:_**
> 
> В Windows для реализации механизма _HTTP Digest Authentication_ для поддержки SSO (Single Sign On) требуют знание вводимого пароля, а не только его хеша. Поэтому разработчики Windows решили хранить пароли пользователей в открытом виде. Для извлечения паролей и хешей из оперативной памяти можно использовать инструмент Mimikatz.

**Mimikatz**

**Mimikatz** — инструмент, реализующий функционал Windows Credentials Editor и позволяющий извлекать учетные данные пользователей Windows.

## Эксплуатация уязвимостей конфигурации ОС Windows

**В этой категории яркими примерами возможных методов повышения привилегий будут следующие:**

- Повышение привилегий через права на создание резервных копий (SeBackupPrivilege)
- Повышение привилегий через перехват сервиса (Weak Services Permission)
- Повышение привилегий через имперсонификацию SeImpersonatePrivilege (JyicyPotato)
- Повышение привилегий через права на установку ПО (AlwaysInstallElevated)
- Повышение привилегий через изменение пути бинарного файла сервиса (Service Binary Path)
- Повышение привилегий через подмену DLL библиотек (DLL Hijacking)
- Повышение привилегий через неэкранированные пути сервисов (Unquoted Service Paths)

## Эксплуатация известных уязвимостей ОС Windows

Приведем пример некоторых достаточно популярных уязвимостей ОС, позволяющих **повысить привилегии до максимальных:**

- Уязвимость в установщике Windows (InstallerFileTakeOver (0day)
- Уязвимость в Windows Print Spooler (PrintNightmare)
- Уязвимость в планировщике задач Windows (MS10-092)
- Уязвимость в ядре Windows (MS16_014)
- Обработка вторичного входа в систему (MS16-032)

**Уязвимость в Windows Print Spooler (PrintNightmare)**

Рассмотрим пример достаточно популярной уязвимости PrintNightmare, т.к. эта проблема до сих пор актуальна и может встречаться в современных сетях компаний.

**Служба Windows Print Spooler** — это универсальный интерфейс между ОС, приложениями и локальными или сетевыми принтерами. Она позволяет разработчикам приложений отправлять задания на печать.

**PrintNightmare** — это критическая уязвимость системы безопасности, затрагивающая операционную систему Microsoft Windows. Есть два варианта ее эксплуатации: один разрешает удаленное выполнение кода, а другой ведет к повышению привилегий. Мы рассмотрим _вариант с повышением привилегий._

**Поиск уязвимости**

Для поиска уязвимости стоит обратиться к списку процессов. В списке процессов стоит обратить внимание на службу печати — _spoolsv_:

## Горизонтальное (“боковое”) перемещение

На этом этапе мы можем **воспользоваться наработками, полученными в ходе этапа повышения привилегий, и переиспользовать их в других машинах сети.** Давайте обсудим, как это устроено, и почему это работает в сетях с Windows машинами под управлением Active Directory.

Боковое перемещение — это одновременное сочетание **2 техник:**

1. Извлечение секретной информации после получения доступа
2. Аутентифицированное удаленное выполнения кода

> _Цикличное, последовательное повторение этих шагов порой позволяет от одного‑единственного взломанного ПК дойти до полной компрометации всей сетевой инфраструктуры._

## **Pass the Hash**

Pass the Hash (PtH) — это метод аутентификации пользователя без доступа к его паролю в открытом виде. Метод заключается в обходе стандартных этапов аутентификации, на которых требуется ввод пароля, и переходе непосредственно к той части аутентификации, которая использует хэш пароля. 

## **Выполнение кода на узле с учетной записью**

Удаленное исполнение кода на узле может выполняться различными способами. Рассмотрим несколько утилит, которые позволят нам удобно работать с выполнением кода на удаленных машинах в будущем.

Psexec.exe

Начиная говорить об удаленном исполнении кода в Windows, нельзя не упомянуть небезызвестный psexec от Марка Руссиновича.

    Происхождение: sysinternals
    Риск детектирования антивирусом: отсутствует
    Используемые порты: 135, 445, 4915x/TCP

Данная программа пользуется одинаковой популярностью и у администраторов, и у пентестеров. Принцип ее работы заключается в копировании исполняемого файла через сетевой ресурс «ADMIN$» (445/TCP) с последующим удаленным созданием и запуском службы для этого исполняемого файла через DCERPC (135,4915x/TCP).

Psexec работает следующим образом:

    Подключается к общей сетевой папке и производит запись сервиса
    Создает сервис через удаленный sc.exe
    Стартует с удаленного сервиса
    Psexec останавливает сервис
    Удаляет сервис
    Удаляет бинарный файл

После запуска службы происходит обычное сетевое взаимодействие с удаленной командной строкой:

psexec.exe -u admin \\target cmd

