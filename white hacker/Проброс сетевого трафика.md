## **Основные понятия**

**Pivoting (англ. Pivot – “точка опоры”)** – техника, которая позволяет хакерам получить доступ к другой части сети, используя  
компьютер, который уже подвергся атаке. Эта техника может быть использована для обхода мер безопасности, установленных на периметре сети, и получения доступа к данным и системам, которые находятся за этим периметром.

**Прокси-сервер (англ. “Proxy”)** — промежуточный сервер в компьютерных сетях, выполняющий роль посредника между  
пользователем и целевым сервером, позволяющий клиентам как выполнять косвенные запросы к другим сетевым службам, так и получать ответы.  
  
**Туннелирование в компьютерных сетях (англ. “Tunneling”)** — процесс, в ходе которого создается логическое соединение  
между двумя конечными точками посредством инкапсуляции различных протоколов.  
  
**Переадресация портов (англ. “Port Forwarding”)** — в компьютерных сетях или сопоставление портов — приложение  
преобразования сетевых адресов, которое перенаправляет запрос связи с одной комбинации адреса и номера порта на другую, в то время как пакеты проходят через сетевой шлюз, такой как маршрутизатор или брандмауэр.  
  
**Port2Port (также известный как P2P)** — это техника перенаправления сетевого трафика между двумя различными портами на  
одном и том же компьютере или между двумя разными компьютерами.  
  
**Port2Hostnet** — это техника перенаправления сетевого трафика через порт в сеть удаленного узла.

## Наше положение в сети

В этой точке сети наша основная задача — **найти наиболее надёжный способ проброса сетевого трафика из той позиции, в которой мы находимся, в локальную сеть компании:** построить “проброс трафика” через 1, 2 или 3 точки доступа, чтобы трафик дошёл до изолированного сегмента, к которому раньше доступа не было.

## **Общие принципы**

Существует множество подходов к пробросу трафика, зависящих от ОС, используемых утилит и различных ограничений. Их можно разделить по критериям:

Используемых инструментов:

Подходы, использующие внутренние инструменты ОС: ssh, nc, bash и пр.
Подходы, использующие внешние утилиты: socat, meterpreter, gost и пр.
Методов сокрытия трафика и обхода ограничений:

Стандартные протоколы, не использующие скрытие трафика: TCP, UDP, HTTPS, SSH, VPN
Нестандартные протоколы, позволяющие обходить системы обнаружения, ограничения и скрывать наличие туннеля: ICMP, DNS, HTTPS (в виде легитимных запросов к приложению)
Проблемы, присущие методам проброса трафика

Нестабильность соединений
Исключение возможности использовать протоколы ниже прикладного или транспортного уровня
Детектирование зловредного трафика в сети
Ограничение соединений между узлами, логическими сегментами сети, используемыми портами


## **Использование стандартных протоколов для проброса трафика:**

**преимущества и недостатки**
При использовании встроенных утилит:

Плюсы:

* Удобство и простота использования
* Возможность использования почти на любой ОС
* Относительная надежность соединения
Минусы:

* Во многих встроенных утилитах отсутствует механизм шифрования трафика
* При использовании внешних утилит:

Плюсы:

* Внедрение механизмов шифрования
* Добавление дополнительных функций поддержания туннеля
* Возможность установки в большинство ОС для использования при отсутствии встроенных механизмов
Минусы:

* Необходимость установки потенциально вредоносного ПО
* Необходимость разбираться в сложных правилах проброса трафика
* Относительная ненадежность использования “самописного” ПО
## Использование встроенных утилит для проброса трафика

Встроенные утилиты отличаются тем, что используют **только легитимные протоколы туннелирования и работы с портами,** что  
исключает возможность их использования для сокрытия трафика в сети или обхода ограничений.

## Использование внешних утилит для проброса трафика

Внешние утилиты позволяют нам не только использовать стандартные протоколы для проброса сетевого трафика, но и **применять изощренные методы передачи трафика в нецелевых для этого протоколах.** Также они могут быть использованы из подручных инструментов, используемых в ходе компрометации: Meterpreter, Cobalt Strike.

Для работы со стандартными протоколами проброса трафика познакомимся с_о следующими популярными утилитами:_

- **Meterpreter** — это продвинутая, динамически расширяемая полезная нагрузка, которая использует [стейджеры](https://encyclopedia.kaspersky.ru/glossary/stager/), инъекции DLL в памяти и распространяется по сети во время выполнения. Он взаимодействует через сокет [стейджера](https://encyclopedia.kaspersky.ru/glossary/stager/) и предоставляет обширный клиентский Ruby API. В нем есть история команд, завершение вкладок, каналы и многое другое.
- **Socat** — расшифровывается как SOcket CAT. Это утилита для передачи данных между двумя адресами. Универсальность socat заключается в том, что адрес может представлять сетевой сокет, любой дескриптор файла, датаграммный или потоковый сокет домена Unix, TCP и UDP (как в IPv4, так и в IPv6), SOCKS 4/4a в IPv4/IPv6, SCTP, PTY, именованные и неименованные конвейеры, OpenSSL, а в Linux — даже любое произвольное сетевое устройство.
- **GOST (GO Simple Tunnel)** — это инструмент для создания зашифрованных туннелей между двумя узлами сети с помощью протокола TCP/UDP, поддерживающий все популярные протоколы проксирования: HTTP/HTTPS/HTTP2/SOCKS4(A)/SOCKS5



## **Meterpreter**

Для проброса трафика через оболочку Meterpreter используется команда `portfwd`. Запустив эту команду на взломанном узле,  
имеющем доступ к атакующей и целевой сети (или системе), мы можем перенаправлять TCP-соединения через эту машину,  
превращая ее в точку поворота. Подобно технике проброса портов, используемой при ssh-соединении, portfwd будет пересылать TCP-соединения к подключенным машинам и от них.

> _Пример команды:_  
>   
> `meterpreter > portfwd add –l 3389 –p 3389 –r [target host]` — эта команда добавляет проброс порта (port forwarding) с локального порта 3389 на удаленный порт 3389 на целевом хосте [target host].

## **GOST**
GO Simple Tunnel не сильно отличается по возможностям от предыдущей утилиты, но имеет более простой синтаксис правил. Также язык разработки GO упрощает компиляцию исполняемого файла под заданную ОС.

Стандартные примеры использования:

Стандартный HTTP/SOCKS5 прокси:
`gost -L=:8080`

Прокси с аутентификацией:
`gost -L=admin:123456@localhost:8080`

## **Использование внешних утилит для скрытия трафика**

Утилиты сокрытия трафика и обхода ограничений используют нестандартные протоколы, такие, как DNS и ICMP, позволяя обойти блокировки или скрыть факт передачи данных.

## **DNS-туннелирование**

DNS-туннелирование (DNS Tunneling) — это метод использования DNS-протокола для передачи данных между компьютерами в
сети.
## **ICMP-туннелирование**

ICMP-туннель — скрытый канал для передачи данных, организованный между двумя узлами, использующий IP-пакеты с типом
протокола ICMP.

**Пример инструмента:**

Hans — делает возможным туннелирование IPv4 через эхо-пакеты ICMP, поэтому его можно назвать туннелем для пинга. Это
может быть полезно в ситуации, когда доступ в Интернет перекрыт, но пинги разрешены.

Для запуска в качестве сервера (от имени root):
` ./hans -s 10.1.2.0 -p password `— это создаст новое tun-устройство и назначит ему IP 10.1.2.1

Для запуска в качестве клиента (от имени root):
` ./hans -c server_addess -p пароль` — это позволит подключиться к серверу по адресу "server_addess", создать новое tun-устройство и назначить ему IP из сети 10.1.2.0/24

Теперь вы можете запустить прокси на сервере или позволить ему действовать как маршрутизатор и использовать NAT, чтобы
разрешить клиентам доступ в Интернет.

