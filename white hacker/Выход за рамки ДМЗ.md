## **Основные понятия**

**Сегмент сети** — логически или физически обособленная часть сети. Разбиение сети на сегменты осуществляется с целью  
оптимизации сетевого трафика и/или повышения безопасности сети в целом.  
  
**Атака «человек посередине» (англ. Man in the middle (MitM))** — вид атаки в компьютерной безопасности, когда  
злоумышленник тайно ретранслирует и при необходимости изменяет связь между двумя сторонами, которые считают, что они  
непосредственно общаются друг с другом.

## Наше положение в сети

Мы уже разобрались с тем, как закреплять доступ к скомпрометированной системе в пределах ДМЗ сети. Теперь мы переходим к новому этапу: **выход за рамки демилитаризованной зоны.**

Единственной и самой важной целью выхода за рамки ДМЗ сети является **получение доступа к внутренним ресурсам организации, хранящим её конфиденциальные данные.**

![[Pasted image 20240609205739.png]]




## Общие принципы

**Для того, чтобы компрометировать сеть ДМЗ, надо понимать, как она устроена:**

- из каких узлов состоит;
- какие возможности даёт каждый из узлов;
- как устроены протоколы взаимодействия.


## **Настройка ДМЗ сети**

**Настройка ДМЗ сети** зависит от конкретного сценария и используемого сетевого оборудования. Однако, общие шаги при настройки ДМЗ сети могут быть следующими:

1. **Определено сетевое оборудование,** которое будет использоваться для настройки ДМЗ сети: это может быть отдельный маршрутизатор или фаервол либо специальный модуль для управления трафиком на маршрутизаторе
2. **Определены IP-адреса для устройств,** которые будут находиться в ДМЗ сети: эти устройства имеют свои уникальные IP-адреса, отличные от адресов локальной сети и сети Интернет
3. **Настроен маршрутизатор или фаервол,** чтобы создать отдельную сеть для ДМЗ: эта сеть должна быть отделена от локальной сети и сети Интернет с помощью фильтров и правил безопасности
4. **Настроены правила безопасности,** чтобы контролировать доступ к устройствам в ДМЗ сети: эти правила должны обеспечивать защиту от внешних атак, но также позволять управлять устройствами в ДМЗ сети из локальной сети

> В сеть ДМЗ могут получать доступ как узлы из недоверенной зоны, так и из внутренней доверенной зоны, но **из сети ДМЗ (хоть она и расположена во внутреннем периметре ИТ-инфраструктуры) получить доступ к внутренней доверенной зоне, по соображениям безопасности, должно быть нельзя.**



## **Популярные способы выхода за рамки сети ДМЗ**

**Компрометация узлов внутри сети ДМЗ, имеющих доступ за рамки сети:**

- Веб-сервисы, чья БД находится в локальной сети компании
- Почтовый сервер, который имеет доступ к домену через протоколы получения доступа к информации из домена
- Терминальный сервер, предоставляющий доступы к файловым серверам и доменным службам

**Компрометация сетевого оборудования и переконфигурация устройств и списков контроля доступа:**

- Компрометация оборудования Cisco, Juniper, MikroTik через известные уязвимости
- Использование простых паролей или подбор паролей через доступные панели администрирования сетевого оборудования
- Приведение к отказу в обслуживании сетевого оборудования для сброса настроек

**Компрометация клиентов, входящих в DMZ сеть на управляемые узлы:**

- Эксплуатация уязвимостей SSH-агентов при подключении к скомпрометированному SSH-серверу
- Эксплуатация уязвимостей браузеров при подключении клиента из локальной сети к скомпрометированному веб-приложению (уязвимости XSS, UXSS, CSRF, Browser RCE и пр.)
- Кража учетных данных клиентов и администраторов на скомпрометированных узлах в ДМЗ и переиспользование их для попадания в локальную сеть

**Обнаружение лазеек (отдельных сегментов / протоколов), которым предоставлен доступ за рамки сети ДМЗ:**

- Обнаружение MultiCast, AnyCast протоколов в трафике, которые могут быть использованы для проведения атак
- Обнаружение доступных из ДМЗ сети логических сегментов локальной сети компании
- Обнаружение протоколов (в т.ч. их стандартных портов), которым позволено выходить за рамки сети ДМЗ (DNS, LDAP, SSH, и пр.)


## **Техники для выхода за рамки сети ДМЗ**

Достаточно изучить **3 техники,** позволяющие воспользоваться любым из описанных выше способов:

1. **Сканирование сети:** для последующей компрометации узлов сети и обнаружения лазеек
2. **Анализ трафика:** для поиска протоколов, которые можно атаковать в последствии
3. **MiTM атаки:** для получения доступа к управлению трафиком за пределами сети ДМЗ




## **Сканирование сети**

**Цели:**

1. Выявление уязвимых сервисов, которые приведут к компрометации новых узлов: SSH (22), FTP (21), SMB/RPC (135/445), MSSQL (1433), PostgreSQL (5432), Redis (6379), Web (80,443), Alternative Web (8080,8443), etc…
2. Выявление доступных маршрутов трафика до узлов во внутренней сети компании: сканирование собственной локальной сети (172.16.0.0/12 или 192.168.0.0/16), сканирование локальной сети организации 10.0.0.0/8
3. Обнаружение доступных сервисов сетевого оборудования: Cisco Smart Install (4786), Web (80,443), Cisco UCS Director Express for Big Data + VNC (8787/ 599), SSH (22), Mikrotik Neighbor Discovery Protocol (5678), Winbox (8291) и пр.

**Поиск сервисов**

Для поиска сервисов мы должны выполнить наиболее эффективные действия в определенном порядке: невозможно просканировать большое сетевое пространство (например: 10.0.0.0/8) и обнаружить в нем все сетевые сервисы в  
краткий промежуток времени.

> **_Основные проблемы:_**
> 
> - Надежность сети
> - Надежность узла сканирования (количество памяти, пропускная способность сети, возможная перегрузка)
> - Высоконагруженные операции сканирования версий и подтверждения открытости портов
> 
> В связи с этим приходится выбирать: **что сканировать в первую очередь, чтобы получить результат.**

Зачастую вы будете стремиться **к 2 целям:**

1. Как можно быстрее определить существующие узлы сети
2. Как можно точнее определить сервисы на существующих узлах


## **Обнаружение лазеек**

Для обнаружения лазеек достаточно просканировать диапазон локальной сети на доступность узлов или отдельных портов и  
протоколов при помощи _nmap_ или _masscan_.  
Обычно локальные сети компаний используют адресацию: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16  
Мы можем проверить доступность отдельных портов TCP/UDP или целых узлов сети:  
`nmap -Pn -n -sU -p53 -T5 10.0.0.0/8` (Сканирование может занимать вплоть до суток)  
`nmap -Pn -n -sS -p22 -T5 10.0.0.0/8`  
`nmap -sn -n -T5 --disable-arp-ping 10.0.0.0/8`

## Анализ трафика

Анализ трафика может помочь нам лучше узнать сеть: выявить протоколы и сетевые соединения, которые относятся и на принадлежащий нам узел сети ДМЗ.

**Что изучать?**

- Широковещательные и мультикаст-пакеты протоколов: mDNS, DHCP, LLMNR, NBT-NS, NDP for IPv6, RTP
- Протоколы, которые впоследствии могут быть использованы для атак: DTP,STP,CDP, и пр.
- Сетевые соединения скомпрометированного узла с узлами остальной сети

> **_Особенности:_**
> 
> - По MAC-адресам в сети возможно обнаружить виртуальные машины
> - По используемым протоколам можно определять используемое в сети ПО и сетевое оборудование

Для анализа трафика чаще всего используются несколько **инструментов захвата и мониторинга трафика:**

- _Wireshark_ — это свободно распространяемый сетевой анализатор, который используется для захвата и анализа сетевого трафика в режиме реального времени. Он позволяет просматривать данные, передаваемые по различным протоколам, и анализировать их в различных форматах.
- _tcpdump_ — это утилита командной строки для захвата сетевого трафика в режиме реального времени. Она используется для мониторинга и анализа трафика на определенном сетевом интерфейсе, с возможностью фильтрации трафика по различным критериям, таким, как IP-адрес и порт назначения или источника.


## **tcpdump**

**tcpdump** — утилита UNIX, позволяющая перехватывать и анализировать сетевой трафик, проходящий через компьютер, на  
котором запущена данная программа. Для выполнения программы требуется наличие прав суперпользователя и прямой доступ к устройству

`sudo tcpdump -i eth0 -nn -s0 -w test.pcap`, где:

- -i : выбирает интерфейс, на котором будет производиться захват; чаще всего это карта ethernet или беспроводной адаптер, но может быть и vlan или что-то более необычное (не всегда требуется, если имеется только один сетевой адаптер)
- -nn : одинарное (n) не будет разрешать имена хостов, двойное (nn) не будет разрешать имена хостов или портов; это удобно не только для просмотра номеров IP/портов, но и при захвате большого количества данных, так как разрешение имен замедляет захват
- -s0 : snap length, размер пакета для захвата, установит неограниченный размер — используйте это, если вы хотите захватить весь трафик (извлечь двоичные файлы из сетевого трафика)
- -w : имя файла для записи захваченного трафика

> Команда _для переноса трафика из tcpdump с удаленного узла, в интерфейс wireshark_ на локальном узле:  
> `ssh root@10.0.5.11 tcpdump -i any -s0 -nn -w - | wireshark -k -i -`
## Атаки MiTM

**Самыми популярными атаками в сети являются атаки:**

- **Спуфинг: в контексте сетевой безопасности spoofing attack (англ. spoofing — подмена)** – это атаки, использующие механизм подмены источника, получателя или арбитра, а также любые ситуации, когда злоумышленник может подменять сущности, условия, значения и пр.
- **Сниффинг : в той же сетевой безопасности sniffing (англ. to sniff — нюхать)** – это атаки прослушивания трафика, проходящего через сетевую карту злоумышленника. _Сниффинг_ может использоваться легально, чтобы изучить, какой трафик получает ваше устройство из сети, или может использоваться нелегитимно, когда злоумышленник нарушает работу сети и заставляет трафик прочих узлов сети проходить через его сетевую карту.

На базе этих 2 атак может быть выполнена наиболее известная сетевая атака: **Man in The Middle (MiTM).** Атаки MiTM бывают очень разными, т.е. использующими разные протоколы, разное поведение протоколов, приводящее к  
различным последствиям.  
  
**Мы познакомимся с такими атаками, как:**

- ARP Spoofing
- MiTM 6
## **ARP Spoofing** 

Протокол разрешения адресов (ARP) предназначен для преобразования IP-адресов в MAC-адреса. Все сетевые устройства,  
которым необходимо взаимодействовать в сети, используют широковещательные ARP-запросы, чтобы узнать MAC-адреса других машин.

**Беспричинный ARP (англ. Gratuitous ARP)**  
  
_Gratuitous ARP (RFC 5227)_ может означать как необоснованный ARP-запрос, так и необоснованный ARP-ответ. Gratuitous в данном случае означает запрос/ответ, который обычно не нужен согласно спецификации ARP (RFC 826), но может быть использован в некоторых случаях.  
  
**Беспричинный ARP запрос** — это пакет запроса Address Resolution Protocol, в котором IP источника и назначения установлены на IP компьютера, издающего пакет, а MAC назначения — широковещательный адрес `ff:ff:ff:ff:ff:ff:ff:ff`. Как правило, никакого ответного пакета не возникает.

> Иначе говоря, беспричинный ARP-ответ — **это ответ, на который не был сделан запрос.**

Также существует вероятность успешной атаки другим способом. Когда вы будете наблюдать за arp-активностью в сегменте сети и вдруг заметите arp-запрос жертвы, вы можете попробовать отправить arp-ответ жертве быстрее, чем адресат этого запроса. Некоторые устройства могут принять этот трюк.

**Инструменты для проведения атаки ARP Spoofing**

[_bettercap_](https://www.bettercap.org/legacy/) - это мощный, легко расширяемый и переносимый фреймворк, написанный на языке Go. Он призван предложить исследователям безопасности, "красным командам" и реверс-инженерам простое в использовании, универсальное решение со всеми функциями, которые могут им понадобиться для проведения разведки и атак на сети WiFi, устройства Bluetooth Low Energy, беспроводные устройства HID и сети Ethernet.

## **MiTM 6**

**Под термином MiTM 6** подразумевают всевозможные атаки на протокол IPv6.  
  
**IPv6** — новая версия интернет-протокола, призванная решить проблемы, с которыми столкнулась предыдущая версия при  
её использовании в Интернете, за счёт целого ряда принципиальных изменений. Протокол был разработан IETF. Длина адреса IPv6 составляет 128 бит, в отличие от адреса IPv4, длина которого равна 32 битам.  
  
Самой популярной атакой на IPv6 является атака: _Rogue DHCP (DHCPv6)._

**Принцип работы:**

- Клиент Ipv6 посылает сообщение Solicit на адрес All_DHCP_Relay_Agents_and_Servers для поиска доступных серверов DHCP
- Любой сервер, который может удовлетворить требования клиента, отвечает сообщением Advertise
- Клиент выбирает один из серверов и посылает серверу сообщение Request с запросом на подтверждение назначения адресов и другой информации о конфигурации
- Сервер отвечает сообщением Reply, содержащим подтвержденные адреса и конфигурацию.

> Эта схема похожа на DHCPv4, поэтому основной целью злоумышленника является **использование поддельного сервера DHCPv6 для перенаправления трафика жертвы на себя.** Злоумышленник может перехватить сообщение клиента DHCP solicit и ответить на него, притворившись, что он является сервером DHCPv6, и назначить учетные данные (например, адрес DNS), которые будут использоваться жертвой.





## Практика
### Задание

Проанализируйте защищенность узла, развернутого вами в виртуальном стенде, определите версию ПО и попытайтесь определить известные уязвимости данной операционной системы. Обнаружьте известную уязвимость, позволяющую извлекать историю паролей учетных записей роутера, и проэксплуатируйте ее при помощи фреймворка metasploit.  
  
В качестве подтверждения успешной эксплуатации предоставьте флаг _(пароль учетной записи администратора, который предшествовал паролю, который вы указывали когда инициализировали роутер, в формате 9 букв, цифр и спецсимволов)._

1. Запускаем стенд и определяем его ip

![[Pasted image 20240612145629.png]]

2. Сканируем его через nmap и определяем версию ПО и оборудование

```shell
nmap -sT -Pn -n -F -sV --open 192.168.103.38                    
Starting Nmap 7.95 ( https://nmap.org ) at 2024-06-12 14:25 MSK
Nmap scan report for 192.168.103.38
Host is up (0.00080s latency).
Not shown: 95 closed tcp ports (conn-refused)
PORT     STATE SERVICE        VERSION
21/tcp   open  ftp            MikroTik router ftpd 6.40.7
22/tcp   open  ssh            MikroTik RouterOS sshd (protocol 2.0)
23/tcp   open  telnet         Linux telnetd
80/tcp   open  http           MikroTik router config httpd
2000/tcp open  bandwidth-test MikroTik bandwidth-test server
Service Info: OSs: Linux, RouterOS; Device: router; CPE: cpe:/o:mikrotik:routeros, cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.26 seconds
```

3. Ищем в Metasploit информацию об уязвимостях оборудования и эксплуатируем их

![[Pasted image 20240612150315.png]]
Ответ: P@sSw0rd!