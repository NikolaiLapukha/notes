## **Основные понятия**

**Каталог (Directory, хранилище данных)** — в контексте компьютерной сети иерархическая структура, хранящая информацию об объектах в сети. Объекты  - это серверы, общие тома и принтеры, учетные записи пользователей и компьютеров сети, а также домены, приложения, службы, политики безопасности и почти все остальное в вашей сети.

**Служба каталогов (Directory Service)** — является как источником информации каталога, так и службой, делающей информацию доступной и полезной для администраторов, пользователей, сетевых служб и приложений. Active Directory™, служба каталогов, входящая в состав Microsoft® Windows® 2000, хранит информацию о сетевых объектах, а также реализует службы, которые делают эту информацию доступной и полезной для пользователей, компьютеров и приложений.

**Объекты (Objects)** — это сущности, составляющие сеть. **Объект** — это отдельный именованный набор атрибутов, представляющий что-то конкретное, например, пользователя, принтер или приложение.

**Схема (Schema)** — это описание классов объектов (различных типов объектов) и атрибутов для этих классов объектов. Для каждого класса объектов схема определяет атрибуты, которые должен иметь этот класс объектов, дополнительные атрибуты, которые он может иметь, и класс объектов, который может быть его родителем. Каждый объект Active Directory является экземпляром класса объекта. Каждый атрибут определяется только один раз и может использоваться в нескольких классах. Например, атрибут Description определяется один раз, но используется во многих различных классах.

**Домены** — это объекты-контейнеры, набор административно определенных объектов, которые имеют общую базу данных каталога, политики безопасности и доверительные отношения с другими доменами. Таким образом, каждый домен является административной границей для объектов. Один домен может охватывать несколько физических мест или сайтов и содержать миллионы объектов.

**Дерево домена (Domain Tree)** — состоит из нескольких доменов, которые имеют общую схему и конфигурацию, образуя непрерывное пространство имен. Домены в дереве также связаны между собой доверительными отношениями. Active Directory представляет собой набор из одного или нескольких деревьев.

**Лес (Forest)** — это набор из одного или нескольких деревьев доменов, которые не образуют непрерывное пространство имен. Все деревья в лесу имеют общую схему, конфигурацию и глобальный каталог. Все деревья в данном лесу обмениваются доверием в соответствии с транзитивными иерархическими отношениями доверия Kerberos. В отличие от деревьев, лес не требует отдельного имени. Лес существует как набор объектов перекрестных ссылок и доверительных отношений Kerberos, распознаваемых входящими в него деревьями. Деревья в лесу образуют иерархию для целей доверия Kerberos; имя дерева в корне дерева доверия относится к данному лесу.

**Доверительные отношения (Trust Relationship)** — это отношения, установленные между двумя доменами, которые позволяют пользователям одного домена быть распознанными контроллером домена в другом домене. Доверительные отношения позволяют пользователям получать доступ к ресурсам в другом домене, а также позволяют администраторам управлять правами пользователей в другом домене.  На уровне леса доверительные отношения создаются автоматически между корневым доменом леса и корневым доменом каждого дерева доменов, добавленного в лес, в результате чего между всеми доменами в лесу Active Directory существует полное доверие.

## ​​​​​​**Наше положение в сети**

Мы переходим промежуточной части большого этапа по захвату локальной сети: **повышению привилегий на узлах локальной сети.**

​​​Наша ​​​​основная задача — проанализировать защищённость контроллера домена, то есть **найти в контроллере домена уязвимости или найти те или иные ресурсы, которые позволяют им управлять**

![[Pasted image 20240614110106.png]]
## **Общие принципы**

В общих случаях захватить контроллер домена возможно **3 различными подходами:**

1. Эксплуатация уязвимости в контроллере домена
2. Кража учетных данных, токенов и сессий привилегированных УЗ
3. Эксплуатация миссконфигураций сервисов в AD, предоставляющих доступ от имени привилегированных учетных записей

Рассмотрим техники, которые относятся к **эксплуатации уязвимости в контроллере домена.**

## **Захват контроллера домена**

В общем случае, назвать захватом домена можно **получение уровня доступа управления контроллером домена из под учетной записи, которая имеет соответствующие права.**

По умолчанию наивысшие права в домене имеет учетная запись из группы _Enterprise Admins._

**Администраторы предприятия (Enterprise Admins)** — это встроенная группа, находится в контейнере Users корневого домена леса, которая по умолчанию имеет административный доступ ко всем доменам в лесу. Enterprise Admins представляет полный доступ к конфигурации всех контроллеров домена. Существует очень мало задач, требующих использования учетной записи Enterprise Admins. 

Есть и другие группы, имеющие наивысшие привилегии в домене после Администраторов Предприятия. Это _Администраторы и Администраторы домена:_

**Администраторы (Administrators)** – находится в контейнере Builtin каждого домена. Эта группа имеет полный доступ ко всем контроллерам домена и данным в контексте именования домена. Она может изменять членство во всех административных группах домена, а группа Администраторы (Administrators) в корневом домене леса может изменять членство в группах _Администраторы предприятия (Enterprise Admins), Администраторы Схемы (Schema Admins) и Администраторы домена (Domain Admins)._ 

**Администраторы домена (Domain Admins)** – находится в контейнере Users каждого домена. Эта группа входит в группу Администраторы своего домена. Поэтому она наследует все полномочия группы Администраторы. Кроме того, она по умолчанию входит в локальную группу Администраторы каждого рядового компьютера домена, в результате чего администраторы домена получают в свое распоряжение все компьютеры домена.

**Возможности групп Администраторов**

Получив права доступа в одной из этих групп, мы можем управлять конфигурацией Домена или даже Леса. Мы можем получить доступ или изменить любые данные учетных записей, машин, сервисов и пр. А также управлять любой машиной в домене и любой учетной записью.

Что еще более интересно, мы можем выгрузить все секреты, ключи, хеши пользователей и пр. учетных записей из контроллера домена и пользоваться ими для создания токенов доступа или входа в машины.

Для эксплуатации такой возможности зачастую используется утилита [SecretsDump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) пакета Impacket, выполняющая атаку под названием _DCSync Attack._

**DCSync Attack**

Разрешение DCSync подразумевает наличие таких разрешений на сам домен: DS-Replication-Get-Changes, Replicating Directory Changes All и Replicating Directory Changes In Filtered Set.

**SecretsDump**

Утилита _secretsdump_ выполняет атаку DCSync Attack и выполняет различные техники для извлечения хэшей с удаленной машины без выполнения на ней какого-либо агента. Для SAM и LSA Secrets (включая кэшированные учетные данные) утилита пытается прочитать как можно больше из реестра, затем сохраняем хэши в целевой системе (`%SYSTEMROOT%\\\Temp dir`) и читает остальные данные оттуда.

**Всегда ли нужны права уровня Администратора?**

_**​**​​​​​​Для достижения цели это нужно не всегда._  
  
Зачастую вашей целью тестирования на проникновение будет являться компрометация узла базы данных (Например, 1С-Предприятия) или узла отвечающего за банковские операции (АРМ КБР или Swift), в таком случае, на пути к получению доступа вам, возможно, не придется захватывать контроллер домена, а достаточно будет, например, захватить управление группой “Администраторы 1С” и др.

**Необходимость захвата КД**

_Захват контроллера домена_ может быть целью анализа защищенности по убеждению Заказчика, для демонстрации наивысшего из возможных ущерба для организации. 

В большинстве случаев, реализующих реальные недопустимые события в организации, в захвате контроллера _нет необходимости,_ если это не событие полного захвата и отказа в обслуживании Домена.
## **Эксплуатация уязвимостей узла контроллера домена**

В серверных системах, которые могут быть настроены как контроллеры домена, а также в протоколах, использующихся контроллерами, появляются и становятся известными уязвимости, позволяющие взломать сервер и захватить на нем полное управление.

_Это один из самых простых способов компрометировать и захватить управление над контроллером домена._

## **Zerologon**

Рассмотрим эксплуатацию одной из самых ярких уязвимостей в контроллере домена.

**Zerologon** — это название уязвимости с идентификатором CVE-2020-1472. Ее так назвали из-за изъяна процесса Netlogon: вектор инициализации (IV), который должен был бы представлять собой случайное число, всегда состоит из одних нулей.

## **Кража учетных данных, токенов и сессий привилегированных УЗ**

Данный подход — один из наиболее распространенных в сетях, **незрелых с точки зрения ИБ заказчиков.** Он подразумевает отсутствие серьезных препятствий на пути пентестера в виде разграничения доступа в сети, T[ier](https://blog.quest.com/the-importance-of-tier-0-and-what-it-means-for-active-directory/)-модели Майкрософт, механизмов Credentials Guard и пр.

> **Пример**
> 
> Вы компрометируете машину в домене при помощи эксплойта и получаете доступ уровня NT Authority/System:
> 
> 1. Вы извлекаете учетные данные, ключи и токены доступа из скомпрометированной машины
> 2. Вы пытаетесь переиспользовать полученные доступы в рамках доступной вам сети, подключаясь с полученными данными к сервисам SMB, HTTP, MSSQL, RPC, WMI и пр. 
> 3. Вы обнаруживаете прочие машины, на которые у вас есть доступ уровня локального администратора
> 4. На скомпрометированных машинах вы вновь извлекаете учетные записи, секреты и токены доступа, уже новых для вас учетных записей
> 5. Так вы повторяете шаги, пока не получите учетные данные кого-либо из групп: Administrators, Domain Admins, Enterprise Admins
> 6. Как только вы получаете эти учетные записи, вы сможете получить доступ к контроллеру домена по WMI или SMB, или выполнить атаку DCSync

## **Привилегированные группы**

Помимо групп, которые имеют прямой доступ к управлению AD, есть группы, чьи привилегии позволяют нам получить доступ к группам первой тройки.

- Group Policy Creators Owners
- Account Operators
- Schema Admins
- Event Log Readers
- Backup Operators
- Remote Management Users
- Server Operators
- DnsAdmins

## **Сбор информации об объектах в домене**

При выборе такого подхода к компрометации домена ваше основное время уйдет **на разведку в домене и энумерацию учетных записей.** 

_Рассмотрим, какие данные важны при сборе информации:_

- Домен
- Доменные политики
- Домен контроллеры
- Пользователи
- Компьютеры
- Группы
- Групповые политики (GPO)
- Организационная единица (OU)
- Список управления доступом (ACL)
- Доверительные отношения (Trusts)
- Лес
- Сессии пользователей
- DNS

## **Одна из утилит для таких атак: Certipy**

Утилита [Certipy](https://github.com/ly4k/Certipy) предназначена для автоматизации процесса генерации и управления сертификатами и ключами шифрования в сетевых приложениях на языке Python. Она предоставляет набор инструментов для создания и управления сертификатами X.509, которые могут быть использованы для обеспечения безопасной передачи данных через сети, например, для шифрования трафика HTTPS.

Далее приведен пример, как эксплуатировать одну из неправильных конфигураций для эскалации в домене с помощью Certipy.

**Эксплуатация с Certipy**

Запрос сертификата по шаблону создания сертификата для другого пользователя:

`$ certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC1-Test -upn administrator@corp.local -dns dc.corp.local`
## **Выводы**

Доменная инфраструктура и конкретно инфраструктура Microsoft Active Directory настолько сложна, наполнена зависимостями и “наследием”, что в своих имплементациях содержит десятки и сотни возможных проблем конфигурации, за которыми сложно или почти невозможно уследить.

**Задачами исследователя безопасности** являются:

- энумерация всех возможных подходов в каждом сегменте доступа;
- исполнение набора цикличных действий по попытке проанализировать защищенность каждого встречающегося в локальной сети ресурса, протокола, механизма и пр. вплоть до достижения поставленной цели.
