## **Основные понятия**

**NBT (NetBIOS over TCP/IP)** — механизм отображения запросов NetBIOS на TCP/IP.  
  
**Служба имен NetBIOS (NBT-NS)** — это протокол Windows, который используется для преобразования имен NetBIOS в IP-адреса в локальной сети.  
  
**LLMNR, англ. Link-Local Multicast Name Resolution** — протокол стека TCP/IP, основанный на формате пакета данных DNS,  
который позволяет компьютерам выполнять разрешение имен хостов в локальной сети.  
  
**MS17-010** — обновление безопасности, устраняющее уязвимости в Microsoft Windows. Наиболее серьезная из уязвимостей может позволить удаленное выполнение кода, если злоумышленник отправит специально созданные сообщения на сервер Microsoft Server Message Block 1.0 (SMBv1).

## ​​​​Наше положение в сети

Мы узнали, какими способами можно перенаправлять наш трафик на сторонние узлы сети. Продолжим тему **выхода за рамки ограниченного сегмента сети.**

**​**​​​​​​Основная задача в этой позиции — **найти как можно больше узлов сети Windows и произвести на них атаки первичного доступа.**

![[Pasted image 20240613123731.png]]
## Общие принципы

Мы уже познакомились с различными аспектами сканирования локальной сети и внешней сети. Повторим важное:

- Сканировать сеть следует, начиная с поиска узлов
- После обнаружения узлов можно заняться сканированием сервисов на них
- Искать стоит только те сервисы, с которыми вы знаете, что нужно делать

Соответственно, когда вы обнаружили существующие узлы в сети и хотите выявить среди них узлы Windows, стоит начать с:

- Сканирования портов, принадлежащих Windows машинам
- Изучения трафика широковещательных запросов, которые инициируют Windows машины

Далее рассмотрим две техники: **обнаружения Windows-машин в сети** и **компрометации Windows-машин**
## **Сканирование портов, принадлежащих Windows машинам**

Сервисы, принадлежащие машинам Windows, которые **могут помочь в определении целей или компрометации системы:**

- _88 - kerberos (Kerberos Key Distribution Center)_ — наличие этого порта помогает определить контроллер домена в сети
- _135 - MSRPC (Microsoft RPC[6])_ — используется в приложениях «клиент-сервер» Microsoft (например, Exchange), позволяет выполнять различные операции в OS при наличии учетных данных
- _137 - NETBIOS-NS (NetBIOS Name Service)_ — позволяет узнать доменное имя машины и ее MAC адрес
- _389 - LDAP (Lightweight Directory Access Protocol)_ — этот порт может дать различные возможности, как по подбору учетных данных, так и по получению доступа к LDAP через эксплуатацию уязвимостей (пример [тут](https://www.rapid7.com/db/modules/auxiliary/admin/ldap/vmware_vcenter_vmdir_auth_bypass/))
- _445 - SMB (Server Message Blocks over IP)_ — протокол SMB имеет ряд уязвимостей и недостатков в различных версиях, которые могут приводить к выполнению кода, захвату пользовательской сессии, получению доступа к данным на файловых серверах
- _1433 - MSSQL (Microsoft SQL Server)_ — сервис MSSQL позволяет получить доступ к управлению БД и, что более важно, выполнить произвольный код на машине Windows, если у нас есть аккаунт для доступа к БД
- 3389 - _RDP (Remote Desktop Protocol)_ — служба удаленных рабочих столов также имеет в истории различные уязвимости, приводящие к выполнению произвольного кода (BlueKeep), и уязвима по отношению к атакам MiTM, позволяющим получить доступ к службе от имени жертвы.
Пример команды для обнаружения узлов с ОС Windows:  
`nmap -Pn -n -sT -p 88,135,137,389,445,1433,3389 -sV -sC --open -iL list-of-machines.txt`

## Анализ трафика широковещательных запросов

Машины Windows активно используют протоколы WPAD, LLMNR, NBT-NS, позволяющие определить, что с высокой долей  
вероятности **именно машины Windows воспользовались данным протоколом.**  
  
**Web Proxy Auto-Discovery Protocol (WPAD) (протокол автоматической настройки прокси)** — метод, используемый клиентами  
для определения места (URL) расположения конфигурационного файла с использованием технологий DHCP и/или DNS.  
  
**Служба имен NetBIOS (NBT-NS)** — это протокол Windows, который используется для преобразования имен NetBIOS в IP-адреса  
в локальной сети.  
  
**Link-Local Multicast Name Resolution (LLMNR)** — протокол стека TCP/IP, основанный на формате пакета данных DNS, который  
позволяет компьютерам выполнять разрешение имен хостов в локальной сети.

## **Широковещательные запросы NBNS, LLMNR:  
на примере работы с протоколом Web Proxy Auto-Discovery Protocol**

Протокол WPAD нужен для того, чтобы автоматически настроить все браузеры в организации без ручного конфигурирования  
каждого. WPAD-стандарт описывает **2 альтернативных метода** распространения информации о расположении файла конфигурации для системных администраторов: с использованием _Dynamic Host Configuration Protocol (DHCP)_ или _Domain Name System (DNS)._

## **Атаки первичного доступа на Windows машины**

Атаки первичного доступа на Windows машины **могут быть предприняты после их обнаружения и использовать следующие  
способы атак:**

- Применение эксплойтов к известным уязвимостям Windows машин
- Применение атак методом перебора
- Перехват трафика и атаки MiTM

## **Применение эксплойтов**

Мы уже знакомы с возможностью обнаруживать уязвимые версии ПО и применять к ним эксплойты. Поговорим о типовых  
уязвимостях и эксплойтов для Windows машин.

Самыми распространенными уязвимостями Windows машин в разное время являлись:

- CVE-2008-4250 (MS08-067)
- CVE-2017-0143 (MS17-010)
- CVE- 2019-0708 (BlueKeep)

## Атаки методом перебора

Не менее эффективными для атак на Windows машины являются и атаки методом перебора: **в каждой Windows машине есть по несколько протоколов, позволяющих реализовывать атаки на механизмы аутентификации.** Небольшое понимание того, какие учетные данные и пароли использовать для подобных атак в определенном контексте, может сильно облегчить этот способ и сделать его крайне эффективным.

**Что может быть подвергнуто атаке в Windows:**

- SMB
- MSSQL
- LDAP
- RDP

> _Пример атаки:_ `hydra -L ~/wordlists/user.txt -P ~/wordlists/pass.txt 192.168.1.5 smb -V`

  
**Подготовка**  
Перед тем, как провести атаку методом перебора, необходимо _ответить на следующие вопросы:_

- Можно ли узнать логины для пользователей в домене?
- Какие пароли использовать для подбора?
- Как не заблокировать пользователей в домене?

**Словарь логинов**  
Словарь логинов из домена можно получить следующими способами:

- С этапа разведки;
- С внешних систем (почта);
- Скомпрометировав какую-либо машину / аккаунт: извлечь адресную книгу почты / получить доступ к LDAP

​**​​​​​​Словарь паролей**  
Словарь паролей можно подготовить, зная привычки / менталитет сотрудников компании. Самыми популярными паролями будут: _Zima2023 , Vfhn2023 (Март2023), Company2023_ и пр., т.е.: использование комбинаций года, месяца, имени компании и пр.

> Словари нужно подбирать **в соответствии с контекстом,** в котором вы их используете.

**Обход блокировки**  
Для обхода блокировки можно использовать атаку PasswordSpraying: 1 попытку подбора пароля для всех аккаунтов в списке в определенный период времени.

## Перехват трафика и MiTM-атаки на машины Windows

Еще одна особенность Windows машин в том, что они **по умолчанию используют протоколы взаимодействия в локальной сети,**  
через которые можно попытаться скомпрометировать каналы коммуникаций и получить доступ к управлению сеансами или  
данными в них.  
  
Мы уже говорили ранее о выполнении Windows машиной алгоритма по разрешению имен в локальной сети.

> **_Повторим_:**  
> каждый раз, когда машина Windows пытается выполнить разрешение доменного имени, она _выполняет следующие действия:_
> 
> 1. Проверяет файл `hosts` для получения информации о системе и ее конфигурации
> 2. Проверяет локальный кэш DNS
> 3. Отправляет запрос к DNS
> 4. Отправляет запрос LLMNR
> 5. Отправляет запрос NBT-NS
> 6. Отправляет запрос MDNS

Как раз в момент использования протоколов LLMNR, NBT-NS и MDNS становится возможным подменить ответ на такой запрос и попытаться завести жертву на свой зловредный ресурс, который сможет:

- Направить жертву в сервис аутентификации и украсть хеш пароля аккаунта (а впоследствии — и сам пароль)
- Провести атаку Relay (захвата сеанса), выполнения команд от имени жертвы в машине, где она прошла аутентификацию, и пр.

Эта атака называется **LLMNR / NBT-NS / MDNS Spoofing.**



